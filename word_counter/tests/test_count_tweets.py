import pytest
from word_counter.word_counter_skeleton import WordCount
from word_counter.read_tweets import get_tweets
from word_counter.views import get_tweets_with_words
from django.test import TestCase
from unittest.mock import patch, Mock
from datetime import datetime
from collections import namedtuple
import tweepy



class TestCountTweets(TestCase):
    Tweet = namedtuple('Status', ['id', 'full_text', 'created_at', 'author'])
    Author = namedtuple('User', ['name', 'screen_name'])

    tweet1 = Tweet(id=431356619243266048,
                   full_text='hola hola hola me llamo juan',
                   created_at=datetime.now(),
                   author=Author(name='perezreverte', screen_name='perezreverte'))

    tweet2 = Tweet(id=431356619243266048,
                   full_text='me me llamo juan juan',
                   created_at=datetime.now(),
                   author=Author(name='perezreverte', screen_name='perezreverte'))
    tweet3 = Tweet(id=431356619243266048,
                   full_text='pepe popo pipo',
                   created_at=datetime(2017, 1, 1),
                   author=Author(name='perezreverte', screen_name='perezreverte'))

    @patch('word_counter.read_tweets.get_tweets')
    def test_count_tweets_words(self, mocked_tweets):
        return_text = '''Y sin embargo, pese a todos ellos y pese a nosotros mismos, España es un lugar estupendo. Me gustaría vivir aquí como un inglés en Marruecos: sin que me importara, sin que me doliera. Ojalá algún día lo consiga. RT @anioljodar: Hola @perezreverte. Imagínate solo, perdido en el mar. ¿Te has preguntado quienes son las personas que bajan al agua para s… RT @Per_Global: En dos horas estará @perezreverte en la Sala de Conferencias de @UCMccinf . Modera @BernaGHarbour . No os lo perdáis, entra… RT @BurriezaMateos: #TalDíaComoHoy de 1907 nació Georges Prosper Remi, más conocido como #Hergé, creador del mítico #Tintín. @zendalibros l… RT @mjsolanofranco: Hoy regresan a Territorio Comanche 25 años depués, José Luís Márquez y @perezreverte. En @zendalibros recordamos aquell… RT @Alfaguara_es: HOY, 22 de mayo, @perezreverte  conversará con el cámara de guerra José Luis Márquez sobre sus experiencias en la profesi… @ASRphotographer El rojo y el negro. RT @Alfaguara_es: Juan Gabriel Vásquez: «Un testigo no puede ver una historia sin participar en ella, sin modificarla ni modificar lo que h… RT @mgsantamarina: Los 8 errores de la temporada 8 de Juego de tronos. #JuegodeTronosfinal #JuegodeTronos #juegodetronos8x06 #Daenerys Mi a… @vicenteal65 Ya sabes a quién. Un abrazo a la familia, viejo vecino. @Barles_ @Alfaguara_es Lo sé, querido amigo. Está disculpado. Un abrazo. RT @Felisin04: Cómo define @perezreverte el Mediterráneo es una obra maestra. https://t.co/VsSEVV6VMn @Felisin04 No tiene mérito. Nací y me crié allí, mirando exactamente eso. RT @Masalladejulio: Campaña para evitar que la Comunidad de Madrid devuelva 192 perros al infierno https://t.co/0MVVwMLceQ a través de @Cab… @LordSmithJ Tiene usted razón. Lo siento. Pero no se me dan bien las mentiras piadosas. RT @nosoyelpunta: Si yo fuera Amancio Ortega compraba Podemos y lo convertía en una peña taurina. Y con éste, viejo también, completamos la trilogía para hoy:
        https://t.co/I6D68qVBbN RT @AMacharowski: Cuentos para niños de los grandes autores actuales @AlmudenaGrandes @perezreverte #ilustracion https://t.co/yqaf61giFY @M… @adacaramelada @Alfaguara_es No en ésa. Sólo me examiné allí del último curso. @JeosmPhoto Dile algo, colega. En plan bien, pero nos está llamando toyacos.
        https://t.co/dyGXzvU8Pc RT @Alfaguara_es: MAÑANA 22 de mayo, @perezreverte  conversará con el cámara de guerra José Luis Márquez sobre sus experiencias en la profe… Es lo de @edugalan y @darioadanti, así que yo de ustedes no iría. O sea, que procuren ir. https://t.co/HPZjKgz9AS'''

        return_tweets = ['Y sin embargo, pese a todos ellos y pese a nosotros mismos, España es un lugar estupendo. Me gustaría vivir aquí como un inglés en Marruecos: sin que me importara, sin que me doliera. Ojalá algún día lo consiga.', 'RT @anioljodar: Hola @perezreverte. Imagínate solo, perdido en el mar. ¿Te has preguntado quienes son las personas que bajan al agua para s…', 'RT @Per_Global: En dos horas estará @perezreverte en la Sala de Conferencias de @UCMccinf . Modera @BernaGHarbour . No os lo perdáis, entra…', 'RT @BurriezaMateos: #TalDíaComoHoy de 1907 nació Georges Prosper Remi, más conocido como #Hergé, creador del mítico #Tintín. @zendalibros l…', 'RT @mjsolanofranco: Hoy regresan a Territorio Comanche 25 años depués, José Luís Márquez y @perezreverte. En @zendalibros recordamos aquell…', 'RT @Alfaguara_es: HOY, 22 de mayo, @perezreverte  conversará con el cámara de guerra José Luis Márquez sobre sus experiencias en la profesi…', '@ASRphotographer El rojo y el negro.', 'RT @Alfaguara_es: Juan Gabriel Vásquez: «Un testigo no puede ver una historia sin participar en ella, sin modificarla ni modificar lo que h…', 'RT @mgsantamarina: Los 8 errores de la temporada 8 de Juego de tronos. #JuegodeTronosfinal #JuegodeTronos #juegodetronos8x06 #Daenerys Mi a…', '@vicenteal65 Ya sabes a quién. Un abrazo a la familia, viejo vecino.', '@Barles_ @Alfaguara_es Lo sé, querido amigo. Está disculpado. Un abrazo.', 'RT @Felisin04: Cómo define @perezreverte el Mediterráneo es una obra maestra. https://t.co/VsSEVV6VMn', '@Felisin04 No tiene mérito. Nací y me crié allí, mirando exactamente eso.', 'RT @Masalladejulio: Campaña para evitar que la Comunidad de Madrid devuelva 192 perros al infierno https://t.co/0MVVwMLceQ a través de @Cab…', '@LordSmithJ Tiene usted razón. Lo siento. Pero no se me dan bien las mentiras piadosas.', 'RT @nosoyelpunta: Si yo fuera Amancio Ortega compraba Podemos y lo convertía en una peña taurina.', 'Y con éste, viejo también, completamos la trilogía para hoy:\nhttps://t.co/I6D68qVBbN', 'RT @AMacharowski: Cuentos para niños de los grandes autores actuales @AlmudenaGrandes @perezreverte #ilustracion https://t.co/yqaf61giFY @M…', '@adacaramelada @Alfaguara_es No en ésa. Sólo me examiné allí del último curso.', '@JeosmPhoto Dile algo, colega. En plan bien, pero nos está llamando toyacos.\nhttps://t.co/dyGXzvU8Pc', 'RT @Alfaguara_es: MAÑANA 22 de mayo, @perezreverte  conversará con el cámara de guerra José Luis Márquez sobre sus experiencias en la profe…', 'Es lo de @edugalan y @darioadanti, así que yo de ustedes no iría. O sea, que procuren ir. https://t.co/HPZjKgz9AS']

        mocked_tweets.return_value= (return_text, return_tweets)
        text, tweets = mocked_tweets()
        expected_result = {"('de', 15)": ['RT @Per_Global: En dos horas estará @perezreverte en la Sala de Conferencias de @UCMccinf . Modera @BernaGHarbour . No os lo perdáis, entra…', 'RT @BurriezaMateos: #TalDíaComoHoy de 1907 nació Georges Prosper Remi, más conocido como #Hergé, creador del mítico #Tintín. @zendalibros l…', 'RT @mjsolanofranco: Hoy regresan a Territorio Comanche 25 años depués, José Luís Márquez y @perezreverte. En @zendalibros recordamos aquell…', 'RT @Alfaguara_es: HOY, 22 de mayo, @perezreverte  conversará con el cámara de guerra José Luis Márquez sobre sus experiencias en la profesi…', 'RT @Alfaguara_es: Juan Gabriel Vásquez: «Un testigo no puede ver una historia sin participar en ella, sin modificarla ni modificar lo que h…', 'RT @mgsantamarina: Los 8 errores de la temporada 8 de Juego de tronos. #JuegodeTronosfinal #JuegodeTronos #juegodetronos8x06 #Daenerys Mi a…', 'RT @Felisin04: Cómo define @perezreverte el Mediterráneo es una obra maestra. https://t.co/VsSEVV6VMn', 'RT @Masalladejulio: Campaña para evitar que la Comunidad de Madrid devuelva 192 perros al infierno https://t.co/0MVVwMLceQ a través de @Cab…', 'RT @nosoyelpunta: Si yo fuera Amancio Ortega compraba Podemos y lo convertía en una peña taurina.', 'RT @AMacharowski: Cuentos para niños de los grandes autores actuales @AlmudenaGrandes @perezreverte #ilustracion https://t.co/yqaf61giFY @M…', '@adacaramelada @Alfaguara_es No en ésa. Sólo me examiné allí del último curso.', 'RT @Alfaguara_es: MAÑANA 22 de mayo, @perezreverte  conversará con el cámara de guerra José Luis Márquez sobre sus experiencias en la profe…', 'Es lo de @edugalan y @darioadanti, así que yo de ustedes no iría. O sea, que procuren ir. https://t.co/HPZjKgz9AS'], "('en', 11)": ['Y sin embargo, pese a todos ellos y pese a nosotros mismos, España es un lugar estupendo. Me gustaría vivir aquí como un inglés en Marruecos: sin que me importara, sin que me doliera. Ojalá algún día lo consiga.', 'RT @anioljodar: Hola @perezreverte. Imagínate solo, perdido en el mar. ¿Te has preguntado quienes son las personas que bajan al agua para s…', 'RT @Per_Global: En dos horas estará @perezreverte en la Sala de Conferencias de @UCMccinf . Modera @BernaGHarbour . No os lo perdáis, entra…', 'RT @BurriezaMateos: #TalDíaComoHoy de 1907 nació Georges Prosper Remi, más conocido como #Hergé, creador del mítico #Tintín. @zendalibros l…', 'RT @mjsolanofranco: Hoy regresan a Territorio Comanche 25 años depués, José Luís Márquez y @perezreverte. En @zendalibros recordamos aquell…', 'RT @Alfaguara_es: HOY, 22 de mayo, @perezreverte  conversará con el cámara de guerra José Luis Márquez sobre sus experiencias en la profesi…', 'RT @Alfaguara_es: Juan Gabriel Vásquez: «Un testigo no puede ver una historia sin participar en ella, sin modificarla ni modificar lo que h…', 'RT @mgsantamarina: Los 8 errores de la temporada 8 de Juego de tronos. #JuegodeTronosfinal #JuegodeTronos #juegodetronos8x06 #Daenerys Mi a…', '@vicenteal65 Ya sabes a quién. Un abrazo a la familia, viejo vecino.', '@Felisin04 No tiene mérito. Nací y me crié allí, mirando exactamente eso.', '@LordSmithJ Tiene usted razón. Lo siento. Pero no se me dan bien las mentiras piadosas.', 'RT @nosoyelpunta: Si yo fuera Amancio Ortega compraba Podemos y lo convertía en una peña taurina.', 'RT @AMacharowski: Cuentos para niños de los grandes autores actuales @AlmudenaGrandes @perezreverte #ilustracion https://t.co/yqaf61giFY @M…', '@adacaramelada @Alfaguara_es No en ésa. Sólo me examiné allí del último curso.', '@JeosmPhoto Dile algo, colega. En plan bien, pero nos está llamando toyacos.\nhttps://t.co/dyGXzvU8Pc', 'RT @Alfaguara_es: MAÑANA 22 de mayo, @perezreverte  conversará con el cámara de guerra José Luis Márquez sobre sus experiencias en la profe…', 'Es lo de @edugalan y @darioadanti, así que yo de ustedes no iría. O sea, que procuren ir. https://t.co/HPZjKgz9AS'], "('la', 7)": ['RT @anioljodar: Hola @perezreverte. Imagínate solo, perdido en el mar. ¿Te has preguntado quienes son las personas que bajan al agua para s…', 'RT @Per_Global: En dos horas estará @perezreverte en la Sala de Conferencias de @UCMccinf . Modera @BernaGHarbour . No os lo perdáis, entra…', 'RT @mjsolanofranco: Hoy regresan a Territorio Comanche 25 años depués, José Luís Márquez y @perezreverte. En @zendalibros recordamos aquell…', 'RT @Alfaguara_es: HOY, 22 de mayo, @perezreverte  conversará con el cámara de guerra José Luis Márquez sobre sus experiencias en la profesi…', 'RT @Alfaguara_es: Juan Gabriel Vásquez: «Un testigo no puede ver una historia sin participar en ella, sin modificarla ni modificar lo que h…', 'RT @mgsantamarina: Los 8 errores de la temporada 8 de Juego de tronos. #JuegodeTronosfinal #JuegodeTronos #juegodetronos8x06 #Daenerys Mi a…', '@vicenteal65 Ya sabes a quién. Un abrazo a la familia, viejo vecino.', 'RT @Masalladejulio: Campaña para evitar que la Comunidad de Madrid devuelva 192 perros al infierno https://t.co/0MVVwMLceQ a través de @Cab…', '@LordSmithJ Tiene usted razón. Lo siento. Pero no se me dan bien las mentiras piadosas.', 'Y con éste, viejo también, completamos la trilogía para hoy:\nhttps://t.co/I6D68qVBbN', '@adacaramelada @Alfaguara_es No en ésa. Sólo me examiné allí del último curso.', '@JeosmPhoto Dile algo, colega. En plan bien, pero nos está llamando toyacos.\nhttps://t.co/dyGXzvU8Pc', 'RT @Alfaguara_es: MAÑANA 22 de mayo, @perezreverte  conversará con el cámara de guerra José Luis Márquez sobre sus experiencias en la profe…', 'Es lo de @edugalan y @darioadanti, así que yo de ustedes no iría. O sea, que procuren ir. https://t.co/HPZjKgz9AS'], "('lo', 7)": ['Y sin embargo, pese a todos ellos y pese a nosotros mismos, España es un lugar estupendo. Me gustaría vivir aquí como un inglés en Marruecos: sin que me importara, sin que me doliera. Ojalá algún día lo consiga.', 'RT @anioljodar: Hola @perezreverte. Imagínate solo, perdido en el mar. ¿Te has preguntado quienes son las personas que bajan al agua para s…', 'RT @Per_Global: En dos horas estará @perezreverte en la Sala de Conferencias de @UCMccinf . Modera @BernaGHarbour . No os lo perdáis, entra…', 'RT @Alfaguara_es: Juan Gabriel Vásquez: «Un testigo no puede ver una historia sin participar en ella, sin modificarla ni modificar lo que h…', 'RT @mgsantamarina: Los 8 errores de la temporada 8 de Juego de tronos. #JuegodeTronosfinal #JuegodeTronos #juegodetronos8x06 #Daenerys Mi a…', '@Barles_ @Alfaguara_es Lo sé, querido amigo. Está disculpado. Un abrazo.', '@LordSmithJ Tiene usted razón. Lo siento. Pero no se me dan bien las mentiras piadosas.', 'RT @nosoyelpunta: Si yo fuera Amancio Ortega compraba Podemos y lo convertía en una peña taurina.', 'Y con éste, viejo también, completamos la trilogía para hoy:\nhttps://t.co/I6D68qVBbN', 'RT @AMacharowski: Cuentos para niños de los grandes autores actuales @AlmudenaGrandes @perezreverte #ilustracion https://t.co/yqaf61giFY @M…', '@adacaramelada @Alfaguara_es No en ésa. Sólo me examiné allí del último curso.', 'Es lo de @edugalan y @darioadanti, así que yo de ustedes no iría. O sea, que procuren ir. https://t.co/HPZjKgz9AS'], "('que', 7)": ['Y sin embargo, pese a todos ellos y pese a nosotros mismos, España es un lugar estupendo. Me gustaría vivir aquí como un inglés en Marruecos: sin que me importara, sin que me doliera. Ojalá algún día lo consiga.', 'RT @anioljodar: Hola @perezreverte. Imagínate solo, perdido en el mar. ¿Te has preguntado quienes son las personas que bajan al agua para s…', 'RT @mjsolanofranco: Hoy regresan a Territorio Comanche 25 años depués, José Luís Márquez y @perezreverte. En @zendalibros recordamos aquell…', 'RT @Alfaguara_es: HOY, 22 de mayo, @perezreverte  conversará con el cámara de guerra José Luis Márquez sobre sus experiencias en la profesi…', 'RT @Alfaguara_es: Juan Gabriel Vásquez: «Un testigo no puede ver una historia sin participar en ella, sin modificarla ni modificar lo que h…', '@Barles_ @Alfaguara_es Lo sé, querido amigo. Está disculpado. Un abrazo.', 'RT @Masalladejulio: Campaña para evitar que la Comunidad de Madrid devuelva 192 perros al infierno https://t.co/0MVVwMLceQ a través de @Cab…', 'RT @Alfaguara_es: MAÑANA 22 de mayo, @perezreverte  conversará con el cámara de guerra José Luis Márquez sobre sus experiencias en la profe…', 'Es lo de @edugalan y @darioadanti, así que yo de ustedes no iría. O sea, que procuren ir. https://t.co/HPZjKgz9AS'], "('el', 6)": ['Y sin embargo, pese a todos ellos y pese a nosotros mismos, España es un lugar estupendo. Me gustaría vivir aquí como un inglés en Marruecos: sin que me importara, sin que me doliera. Ojalá algún día lo consiga.', 'RT @anioljodar: Hola @perezreverte. Imagínate solo, perdido en el mar. ¿Te has preguntado quienes son las personas que bajan al agua para s…', 'RT @BurriezaMateos: #TalDíaComoHoy de 1907 nació Georges Prosper Remi, más conocido como #Hergé, creador del mítico #Tintín. @zendalibros l…', 'RT @mjsolanofranco: Hoy regresan a Territorio Comanche 25 años depués, José Luís Márquez y @perezreverte. En @zendalibros recordamos aquell…', 'RT @Alfaguara_es: HOY, 22 de mayo, @perezreverte  conversará con el cámara de guerra José Luis Márquez sobre sus experiencias en la profesi…', '@ASRphotographer El rojo y el negro.', 'RT @Alfaguara_es: Juan Gabriel Vásquez: «Un testigo no puede ver una historia sin participar en ella, sin modificarla ni modificar lo que h…', 'RT @Felisin04: Cómo define @perezreverte el Mediterráneo es una obra maestra. https://t.co/VsSEVV6VMn', '@Felisin04 No tiene mérito. Nací y me crié allí, mirando exactamente eso.', 'RT @Masalladejulio: Campaña para evitar que la Comunidad de Madrid devuelva 192 perros al infierno https://t.co/0MVVwMLceQ a través de @Cab…', 'RT @nosoyelpunta: Si yo fuera Amancio Ortega compraba Podemos y lo convertía en una peña taurina.', '@adacaramelada @Alfaguara_es No en ésa. Sólo me examiné allí del último curso.', 'RT @Alfaguara_es: MAÑANA 22 de mayo, @perezreverte  conversará con el cámara de guerra José Luis Márquez sobre sus experiencias en la profe…'], "('sin', 5)": ['Y sin embargo, pese a todos ellos y pese a nosotros mismos, España es un lugar estupendo. Me gustaría vivir aquí como un inglés en Marruecos: sin que me importara, sin que me doliera. Ojalá algún día lo consiga.', 'RT @Alfaguara_es: Juan Gabriel Vásquez: «Un testigo no puede ver una historia sin participar en ella, sin modificarla ni modificar lo que h…', 'RT @Felisin04: Cómo define @perezreverte el Mediterráneo es una obra maestra. https://t.co/VsSEVV6VMn', '@Felisin04 No tiene mérito. Nací y me crié allí, mirando exactamente eso.'], "('un', 5)": ['Y sin embargo, pese a todos ellos y pese a nosotros mismos, España es un lugar estupendo. Me gustaría vivir aquí como un inglés en Marruecos: sin que me importara, sin que me doliera. Ojalá algún día lo consiga.', 'RT @anioljodar: Hola @perezreverte. Imagínate solo, perdido en el mar. ¿Te has preguntado quienes son las personas que bajan al agua para s…', 'RT @Alfaguara_es: Juan Gabriel Vásquez: «Un testigo no puede ver una historia sin participar en ella, sin modificarla ni modificar lo que h…', '@vicenteal65 Ya sabes a quién. Un abrazo a la familia, viejo vecino.', '@Barles_ @Alfaguara_es Lo sé, querido amigo. Está disculpado. Un abrazo.', 'RT @Felisin04: Cómo define @perezreverte el Mediterráneo es una obra maestra. https://t.co/VsSEVV6VMn', 'RT @Masalladejulio: Campaña para evitar que la Comunidad de Madrid devuelva 192 perros al infierno https://t.co/0MVVwMLceQ a través de @Cab…', 'RT @nosoyelpunta: Si yo fuera Amancio Ortega compraba Podemos y lo convertía en una peña taurina.'], "('para', 4)": ['RT @anioljodar: Hola @perezreverte. Imagínate solo, perdido en el mar. ¿Te has preguntado quienes son las personas que bajan al agua para s…', 'RT @Masalladejulio: Campaña para evitar que la Comunidad de Madrid devuelva 192 perros al infierno https://t.co/0MVVwMLceQ a través de @Cab…', 'Y con éste, viejo también, completamos la trilogía para hoy:\nhttps://t.co/I6D68qVBbN', 'RT @AMacharowski: Cuentos para niños de los grandes autores actuales @AlmudenaGrandes @perezreverte #ilustracion https://t.co/yqaf61giFY @M…'], "('con', 3)": ['Y sin embargo, pese a todos ellos y pese a nosotros mismos, España es un lugar estupendo. Me gustaría vivir aquí como un inglés en Marruecos: sin que me importara, sin que me doliera. Ojalá algún día lo consiga.', 'RT @Per_Global: En dos horas estará @perezreverte en la Sala de Conferencias de @UCMccinf . Modera @BernaGHarbour . No os lo perdáis, entra…', 'RT @BurriezaMateos: #TalDíaComoHoy de 1907 nació Georges Prosper Remi, más conocido como #Hergé, creador del mítico #Tintín. @zendalibros l…', 'RT @Alfaguara_es: HOY, 22 de mayo, @perezreverte  conversará con el cámara de guerra José Luis Márquez sobre sus experiencias en la profesi…', 'RT @nosoyelpunta: Si yo fuera Amancio Ortega compraba Podemos y lo convertía en una peña taurina.', 'Y con éste, viejo también, completamos la trilogía para hoy:\nhttps://t.co/I6D68qVBbN', 'RT @Alfaguara_es: MAÑANA 22 de mayo, @perezreverte  conversará con el cámara de guerra José Luis Márquez sobre sus experiencias en la profe…']}
        self.assertEqual(get_tweets_with_words(text, tweets), expected_result)

    @patch('word_counter.read_tweets.get_tweets')
    def test_no_tweets(self, mocked_tweets):
        mocked_tweets.return_value = ('', '')
        with self.assertRaises(ValueError):
            text, tweets = mocked_tweets(time_interval=7, user="perezreverte")
            get_tweets_with_words(text, tweets)

    @patch('word_counter.read_tweets.get_tweets')
    def test_with_runtime_error_tweets(self, mocked_tweets):
        mocked_tweets.return_value = RuntimeError("")
        with self.assertRaises(TypeError):
            text, tweets = mocked_tweets(time_interval=7, user="perezreverte")
            get_tweets_with_words(text, tweets)

    @patch.object(tweepy.API, 'user_timeline')
    def test_with_runtime_error_tweets(self, mocked_user_timeline):
        mocked_user_timeline.return_value = [self.tweet1, self.tweet2, self.tweet3]
        text, tweets = get_tweets()
        expected_result = {"('hola', 3)": ['hola hola hola me llamo juan'], "('juan', 3)": ['hola hola hola me llamo juan', 'me me llamo juan juan'], "('llamo', 2)": ['hola hola hola me llamo juan', 'me me llamo juan juan']}
        self.assertEqual(get_tweets_with_words(text, tweets), expected_result)
